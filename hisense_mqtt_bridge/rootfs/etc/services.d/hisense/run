#!/usr/bin/with-contenv bashio
set -e

CONFIG_PATH=/data/options.json

# Read config from HA Add-on options
TV_IP=$(bashio::config 'tv_ip')
TV_PORT=$(bashio::config 'tv_port')
TV_CLIENT_ID=$(bashio::config 'tv_client_id')
MQTT_HOST=$(bashio::config 'mqtt_host')
MQTT_PORT=$(bashio::config 'mqtt_port')
MQTT_USER=$(bashio::config 'mqtt_username')
MQTT_PASS=$(bashio::config 'mqtt_password')
DEVICE_ID=$(bashio::config 'device_id')
DEVICE_NAME=$(bashio::config 'device_name')
VOLUME_MAX=$(bashio::config 'volume_max')

# Create config.yaml for the bridge
cat > /app/config.yaml << EOF
tv:
  ip: "${TV_IP}"
  port: ${TV_PORT}
  client_id: "${TV_CLIENT_ID}"
mqtt:
  host: "${MQTT_HOST}"
  port: ${MQTT_PORT}
  username: "${MQTT_USER}"
  password: "${MQTT_PASS}"
device:
  id: "${DEVICE_ID}"
  name: "${DEVICE_NAME}"
  topic_prefix: "hisense/${DEVICE_ID/hisense_/}"
volume:
  max: ${VOLUME_MAX}
  step: 1
EOF

bashio::log.info "Starting Hisense TV MQTT Bridge..."
bashio::log.info "TV: ${TV_IP}:${TV_PORT}"
bashio::log.info "MQTT: ${MQTT_HOST}:${MQTT_PORT}"

exec python3 -u /app/hisense_bridge.py
